<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../lib/mui/css/mui.min.css" rel="stylesheet" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">圈存</h1>
		</header>
		<div class="mui-content">
			<form class="mui-input-group">
				<div class="mui-input-row">
					<label>银行卡号</label>
					<input id="accNo" type="text" class="mui-input" placeholder="请核对银行账号" readonly="readonly">
				</div>
				<div class="mui-input-row">
					<label>账户姓名</label>
					<input id="accName" type="text" class="mui-input" placeholder="请核对账户姓名" readonly="readonly" />
				</div>
				<div class="mui-input-row">
					<label>圈存金额</label>
					<input id="money" type="text" class="mui-input-clear" placeholder="请输入圈存金额">
				</div>
				<div class="mui-input-row">
					<label>主卡密码</label>
					<input id="memberPass" type="password" class="mui-input-clear" placeholder="请输入主卡密码">
				</div>
				<div class="mui-input-row">
					<input id='sms_code' type="text" class="mui-input-clear mui-input" placeholder="短信验证码" style="width: 60%;float: left;">
					<a id='btnGetSms' class="mui-btn" data-loading-text="60秒后重新获取" style="width: 38%">获取验证码</a>
				</div>
			</form>
			<div class="mui-content-padded">
				<button id='btnSubmit' class="mui-btn mui-btn-block mui-btn-primary">确认圈存</button>
			</div>
		</div>
		<script src="../../lib/mui/js/mui.min.js"></script>
		<script src="../../js/common/common.js"></script>
		<script type="text/javascript">
			(function($, doc) {
				$.init();

				function toLogin() {
					plus.nativeUI.toast('请登录');
					$.openWindow({
						url: '../login/login.html',
						id: 'login'
					});
				}

				function toTradeResult(title, description, data) {
					data = data || {
						trans_serial_no: '',
						trans_id: '',
						trade_date: ''
					};
					var webview = mui.openWindow({
						url: 'trade_result.html',
						extras: {
							r_type: 'recharge',
							r_title: title,
							r_description: description,
							r_trans_serial_no: data.trans_serial_no,
							r_trans_id: data.trans_id,
							r_time: data.trade_date
						}
					});
				}

				$.plusReady(function() {
					var localSettings = common.getSettings();
					if(common.isEmptyObject(localSettings)) {
						toLogin();
						return false;
					}

					var accNo = doc.getElementById('accNo');
					var accName = doc.getElementById('accName');
					var money = doc.getElementById('money');
					var memberPass = doc.getElementById('memberPass');
					var bindAcc = {};
					var data = {};

					//加载已绑定的圈存银行卡
					common.postJSON(common.getServiceUrl('getFirstMemberBankcard'), {
						access_token: localSettings.access_token,
						memberInfoId: localSettings.member_pk,
						isRecharge: 1
					}, function(result) {
						if(result.success) {
							bindAcc = result.data;
							accNo.value = bindAcc.bankAccCard;
							accName.value = bindAcc.bankAccName;
						} else {
							plus.nativeUI.toast(common.msg.msgServerErr());
						}
					});

					//	------begin: 提交预支付交易并获取短信验证码------
					btnGetSms.addEventListener('tap', function() {
						//获取验证码之前验证表单
						if(common.isNullOrEmpty(money.value)) {
							plus.nativeUI.toast('请输入圈存金额');
							return false;
						} else if(!common.isMoney(money.value)) {
							plus.nativeUI.toast('圈存金额格式不正确');
							return false;
						}
						if(common.isNullOrEmpty(memberPass.value)) {
							plus.nativeUI.toast('请输入主卡密码');
							return false;
						}
						if(common.isNullOrEmpty(accNo.value)) {
							return false;
						}
						if(common.isNullOrEmpty(accName.value)) {
							return false;
						}

						btnGetSms.disabled = true;
						var count = 60;
						var timer = setInterval(function() {
							if(count === 0) {
								clearInterval(timer);
								btnGetSms.disabled = false;
								btnGetSms.innerHTML = '获取验证码';
							} else {
								btnGetSms.innerHTML = count + '秒后重新获取';
								count--;
							}
						}, 1000);

						//请求结算系统验证主卡密码
						common.postJSON(common.getServiceUrl('checkMemberPass'), {
							access_token: localSettings.access_token,
							memberNo: localSettings.member_no,
							password: memberPass.value
						}, function(result) {
							console.log(JSON.stringify(result));
							if(result.data.result == '1') {
								//提交预交易并发送短信验证码
								common.postJSON(common.getServiceUrl('preRecharge'), {
									access_token: localSettings.access_token,
									bind_id: bindAcc.bfBindId,
									txn_amt: money.value
								}, function(result) {
									if(result.success) {
										data = result.data;
									} else {
										plus.nativeUI.alert(result.msg);
									}
									clearInterval(timer);
									btnGetSms.disabled = false;
									btnGetSms.innerHTML = '获取验证码';
								});
							} else {
								plus.nativeUI.alert('密码错误');
								return false;
							}
						});
					});
					//	------end: 提交预支付交易并获取短信验证码------

					//------begin: 确认圈存交易------
					btnSubmit.addEventListener('tap', function() {
						if(common.isNullOrEmpty(sms_code.value)) {
							plus.nativUI.toast('请输入短信验证码');
							return false;
						}
						data.sms_code = sms_code.value;
						data.access_token = localSettings.access_token;
						common.postJSON(common.getServiceUrl('recharge'), data, function(result) {
							console.log(JSON.stringify(result));
							if(result.success) {
								plus.nativeUI.toast(result.msg);
								toTradeResult('交易处理成功', '圈存交易成功！', result.data);
							} else {
								plus.nativeUI.toast(result.msg);
								toTradeResult('交易处理失败', '圈存交易遇到错误。' + result.msg, result.data);
							}
						})
					});
					//------end: 确认圈存交易------
				});
			}(mui, document));
		</script>
	</body>

</html>